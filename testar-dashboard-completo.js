// Script para testar o sistema completo de dashboard com estat√≠sticas

import { solicitacoesService, entregasService, whitelistService } from './src/lib/services.js';

async function testarDashboardCompleto() {
  console.log('üìä Testando sistema completo de dashboard...\n');
  
  try {
    // 1. Adicionar alguns VIPs para teste
    console.log('1Ô∏è‚É£ Adicionando VIPs para teste...');
    const vips = [
      { phone: '+5511999999999', name: 'Jo√£o Silva', role: 'L√≠der', municipio: 'S√£o Paulo' },
      { phone: '+5511888888888', name: 'Maria Santos', role: 'Coordenadora', municipio: 'Rio de Janeiro' },
      { phone: '+5511777777777', name: 'Pedro Costa', role: 'L√≠der', municipio: 'Belo Horizonte' },
      { phone: '+5511666666666', name: 'Ana Oliveira', role: 'Coordenadora', municipio: 'Salvador' },
      { phone: '+5511555555555', name: 'Carlos Lima', role: 'L√≠der', municipio: 'Bras√≠lia' }
    ];

    for (const vip of vips) {
      try {
        await whitelistService.addVip(vip.phone, vip.name, vip.role, vip.municipio);
        console.log(`‚úÖ VIP adicionado: ${vip.name} - ${vip.municipio}`);
      } catch (error) {
        console.log(`‚ö†Ô∏è VIP j√° existe: ${vip.name}`);
      }
    }

    // 2. Simular solicita√ß√µes com valores
    console.log('\n2Ô∏è‚É£ Simulando solicita√ß√µes com valores...');
    const solicitacoesComValores = [
      {
        phone_number: '+5511999999999',
        nome_solicitante: 'Jo√£o Silva',
        municipio_solicitante: 'S√£o Paulo',
        material_solicitado: 'Bandeiras para evento de domingo',
        quantidade: 50,
        valor_unitario: 15.00,
        valor_total: 750.00,
        observacoes: 'Evento importante no centro da cidade'
      },
      {
        phone_number: '+5511888888888',
        nome_solicitante: 'Maria Santos',
        municipio_solicitante: 'Rio de Janeiro',
        material_solicitado: 'Santinhos para distribuir na feira',
        quantidade: 1000,
        valor_unitario: 0.50,
        valor_total: 500.00,
        observacoes: 'Feira municipal no s√°bado'
      },
      {
        phone_number: '+5511777777777',
        nome_solicitante: 'Pedro Costa',
        municipio_solicitante: 'Belo Horizonte',
        material_solicitado: 'Adesivos para colar nos carros',
        quantidade: 200,
        valor_unitario: 2.00,
        valor_total: 400.00,
        observacoes: 'Campanha de rua'
      },
      {
        phone_number: '+5511666666666',
        nome_solicitante: 'Ana Oliveira',
        municipio_solicitante: 'Salvador',
        material_solicitado: 'Camisetas para a equipe',
        quantidade: 20,
        valor_unitario: 25.00,
        valor_total: 500.00,
        observacoes: 'Equipe de volunt√°rios'
      },
      {
        phone_number: '+5511555555555',
        nome_solicitante: 'Carlos Lima',
        municipio_solicitante: 'Bras√≠lia',
        material_solicitado: 'Bon√©s para distribui√ß√£o',
        quantidade: 100,
        valor_unitario: 12.00,
        valor_total: 1200.00,
        observacoes: 'Evento de inaugura√ß√£o'
      },
      {
        phone_number: '+5511999999999',
        nome_solicitante: 'Jo√£o Silva',
        municipio_solicitante: 'S√£o Paulo',
        material_solicitado: 'Panfletos para campanha',
        quantidade: 500,
        valor_unitario: 0.30,
        valor_total: 150.00,
        observacoes: 'Segunda solicita√ß√£o do Jo√£o'
      }
    ];

    for (const solicitacao of solicitacoesComValores) {
      const resultado = await solicitacoesService.add(solicitacao);
      console.log(`‚úÖ Solicita√ß√£o registrada: ${resultado.nome_solicitante} - ${resultado.material_solicitado} - R$ ${resultado.valor_total}`);
    }

    // 3. Simular aprova√ß√µes e rejei√ß√µes
    console.log('\n3Ô∏è‚É£ Simulando aprova√ß√µes e rejei√ß√µes...');
    const todasSolicitacoes = await solicitacoesService.getAll();
    
    // Aprovar algumas solicita√ß√µes
    const aprovacoes = [
      { id: todasSolicitacoes[0].id, resposta: 'Solicita√ß√£o aprovada! Entraremos em contato para combinar a entrega.' },
      { id: todasSolicitacoes[1].id, resposta: 'Aprovado! Temos o material dispon√≠vel.' },
      { id: todasSolicitacoes[2].id, resposta: 'Solicita√ß√£o aprovada com sucesso.' }
    ];

    for (const aprovacao of aprovacoes) {
      await solicitacoesService.updateStatus(aprovacao.id, 'aprovada', aprovacao.resposta, '2024-01-15');
      console.log(`‚úÖ Solicita√ß√£o ${aprovacao.id} aprovada`);
    }

    // Rejeitar uma solicita√ß√£o
    await solicitacoesService.updateStatus(todasSolicitacoes[3].id, 'rejeitada', 'Infelizmente n√£o temos este material dispon√≠vel no momento.');
    console.log(`‚ùå Solicita√ß√£o ${todasSolicitacoes[3].id} rejeitada`);

    // 4. Simular entregas realizadas
    console.log('\n4Ô∏è‚É£ Simulando entregas realizadas...');
    const entregas = [
      {
        solicitacao_id: todasSolicitacoes[0].id,
        phone_number: '+5511999999999',
        nome_solicitante: 'Jo√£o Silva',
        municipio_solicitante: 'S√£o Paulo',
        material_entregue: 'Bandeiras para evento de domingo',
        quantidade_entregue: 50,
        valor_unitario: 15.00,
        valor_total_entregue: 750.00,
        data_entrega: '2024-01-15',
        responsavel_entrega: 'Equipe de Log√≠stica',
        observacoes_entrega: 'Entregue no local do evento'
      },
      {
        solicitacao_id: todasSolicitacoes[1].id,
        phone_number: '+5511888888888',
        nome_solicitante: 'Maria Santos',
        municipio_solicitante: 'Rio de Janeiro',
        material_entregue: 'Santinhos para distribuir na feira',
        quantidade_entregue: 1000,
        valor_unitario: 0.50,
        valor_total_entregue: 500.00,
        data_entrega: '2024-01-16',
        responsavel_entrega: 'Equipe de Log√≠stica',
        observacoes_entrega: 'Entregue na sede do partido'
      }
    ];

    for (const entrega of entregas) {
      const resultado = await entregasService.add(entrega);
      console.log(`‚úÖ Entrega registrada: ${resultado.nome_solicitante} - R$ ${resultado.valor_total_entregue}`);
    }

    // 5. Testar estat√≠sticas gerais
    console.log('\n5Ô∏è‚É£ Testando estat√≠sticas gerais...');
    const statsSolicitacoes = await solicitacoesService.getStats();
    console.log('üìä Estat√≠sticas de Solicita√ß√µes:');
    console.log(`- Total: ${statsSolicitacoes.total_solicitacoes}`);
    console.log(`- Pendentes: ${statsSolicitacoes.solicitacoes_pendentes}`);
    console.log(`- Aprovadas: ${statsSolicitacoes.solicitacoes_aprovadas}`);
    console.log(`- Rejeitadas: ${statsSolicitacoes.solicitacoes_rejeitadas}`);
    console.log(`- Valor total solicitado: R$ ${statsSolicitacoes.valor_total_solicitado}`);
    console.log(`- Valor total aprovado: R$ ${statsSolicitacoes.valor_total_aprovado}`);

    // 6. Testar estat√≠sticas por l√≠der
    console.log('\n6Ô∏è‚É£ Testando estat√≠sticas por l√≠der...');
    const statsPorLider = await solicitacoesService.getStatsPorLider();
    console.log('üë• Estat√≠sticas por L√≠der:');
    statsPorLider.forEach(lider => {
      console.log(`- ${lider.nome_solicitante} (${lider.municipio_solicitante}):`);
      console.log(`  * Solicita√ß√µes: ${lider.total_solicitacoes}`);
      console.log(`  * Aprovadas: ${lider.solicitacoes_aprovadas}`);
      console.log(`  * Valor solicitado: R$ ${lider.valor_total_solicitado}`);
      console.log(`  * Valor aprovado: R$ ${lider.valor_total_aprovado}`);
    });

    // 7. Testar estat√≠sticas por munic√≠pio
    console.log('\n7Ô∏è‚É£ Testando estat√≠sticas por munic√≠pio...');
    const statsPorMunicipio = await solicitacoesService.getStatsPorMunicipio();
    console.log('üèôÔ∏è Estat√≠sticas por Munic√≠pio:');
    statsPorMunicipio.forEach(municipio => {
      console.log(`- ${municipio.municipio_solicitante}:`);
      console.log(`  * L√≠deres: ${municipio.total_lideres}`);
      console.log(`  * Solicita√ß√µes: ${municipio.total_solicitacoes}`);
      console.log(`  * Valor solicitado: R$ ${municipio.valor_total_solicitado}`);
      console.log(`  * Valor aprovado: R$ ${municipio.valor_total_aprovado}`);
      console.log(`  * Valor m√©dio: R$ ${municipio.valor_medio_por_solicitacao}`);
    });

    // 8. Testar estat√≠sticas por material
    console.log('\n8Ô∏è‚É£ Testando estat√≠sticas por material...');
    const statsPorMaterial = await solicitacoesService.getStatsPorMaterial();
    console.log('üì¶ Estat√≠sticas por Material:');
    statsPorMaterial.forEach(material => {
      console.log(`- ${material.material_solicitado}:`);
      console.log(`  * Solicita√ß√µes: ${material.total_solicitacoes}`);
      console.log(`  * Quantidade solicitada: ${material.quantidade_total_solicitada}`);
      console.log(`  * Quantidade aprovada: ${material.quantidade_aprovada}`);
      console.log(`  * Valor solicitado: R$ ${material.valor_total_solicitado}`);
      console.log(`  * Valor aprovado: R$ ${material.valor_total_aprovado}`);
      console.log(`  * Valor m√©dio unit√°rio: R$ ${material.valor_medio_unitario}`);
    });

    // 9. Testar estat√≠sticas de entregas
    console.log('\n9Ô∏è‚É£ Testando estat√≠sticas de entregas...');
    const statsEntregas = await entregasService.getStats();
    console.log('üöö Estat√≠sticas de Entregas:');
    console.log(`- Total de entregas: ${statsEntregas.total_entregas}`);
    console.log(`- Quantidade total entregue: ${statsEntregas.quantidade_total_entregue}`);
    console.log(`- Valor total entregue: R$ ${statsEntregas.valor_total_entregue}`);
    console.log(`- L√≠deres atendidos: ${statsEntregas.total_lideres_atendidos}`);
    console.log(`- Munic√≠pios atendidos: ${statsEntregas.total_municipios_atendidos}`);
    console.log(`- Valor m√©dio por entrega: R$ ${statsEntregas.valor_medio_por_entrega}`);

    // 10. Testar estat√≠sticas de entregas por l√≠der
    console.log('\nüîü Testando estat√≠sticas de entregas por l√≠der...');
    const statsEntregasPorLider = await entregasService.getStatsPorLider();
    console.log('üë• Entregas por L√≠der:');
    statsEntregasPorLider.forEach(lider => {
      console.log(`- ${lider.nome_solicitante} (${lider.municipio_solicitante}):`);
      console.log(`  * Entregas: ${lider.total_entregas}`);
      console.log(`  * Quantidade entregue: ${lider.quantidade_total_entregue}`);
      console.log(`  * Valor entregue: R$ ${lider.valor_total_entregue}`);
      console.log(`  * Valor m√©dio: R$ ${lider.valor_medio_por_entrega}`);
    });

    console.log('\n‚úÖ Teste do dashboard completo conclu√≠do com sucesso!');
    console.log('\nüìã Resumo do que foi testado:');
    console.log('- ‚úÖ Adi√ß√£o de VIPs');
    console.log('- ‚úÖ Solicita√ß√µes com valores');
    console.log('- ‚úÖ Aprova√ß√µes e rejei√ß√µes');
    console.log('- ‚úÖ Registro de entregas');
    console.log('- ‚úÖ Estat√≠sticas gerais');
    console.log('- ‚úÖ Estat√≠sticas por l√≠der');
    console.log('- ‚úÖ Estat√≠sticas por munic√≠pio');
    console.log('- ‚úÖ Estat√≠sticas por material');
    console.log('- ‚úÖ Estat√≠sticas de entregas');
    console.log('- ‚úÖ Estat√≠sticas de entregas por l√≠der');
    
  } catch (error) {
    console.error('‚ùå Erro durante o teste:', error);
  }
}

// Executar teste
testarDashboardCompleto();
